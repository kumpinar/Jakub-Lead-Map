<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Lead Map</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.css" rel="stylesheet">
    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
    </style>
    <link href="style.css" rel="stylesheet">


    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDsnXEGVGThb-OnBXG20PjFvRMdgFw-vDc",
            authDomain: "lemon-lead-map.firebaseapp.com",
            projectId: "lemon-lead-map",
            storageBucket: "lemon-lead-map.appspot.com",
            messagingSenderId: "1095389983309",
            appId: "1:1095389983309:web:5eb6344c31006cdb8e6204"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
    </script>
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/monday-sdk-js/dist/main.js"></script>

</head>

<body>

    <div id="map">
        <div id="left" class="sidebar flex-center left collapsed">
            <div class="sidebar-content rounded-rect flex-center">
                <div class="legend">
                    <b>Countries</b>
                    <div>
                        <ul id="countries">

                        </ul>
                    </div>
                    <b>Industries</b>
                    <div>
                        <ul id="industries">

                        </ul>
                    </div>
                    <b>Leads</b>
                    <div id="leads">
                    </div>
                    <b>Clients</b>
                    <div id="clients">
                    </div>
                </div>
                <div id="sidebar-arrow" class="sidebar-toggle rounded-rect left" onclick="toggleSidebar('left')">
                    &rarr;
                </div>
            </div>
        </div>
    </div>



    <script src="js/jquery.min.js"></script>
    <script src="bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="js/bootbox.js"></script>
    

    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoieWFycmFyYW5nZXMiLCJhIjoiY2tydHpnM2pwOXdldzJubDM1b2dvcm15cCJ9.sAkVnbCzwrVLLRi7xxiHnA';
        let mondayToken = localStorage.getItem('monday-token');

        const countries = [
            {
                name: 'Poland',
                industries: [
                    {
                        name: 'Photovoltaic',
                        boardId: '1284229859',
                        goodGroupIds: ['nowa_grupa24985', 'new_group17485'],
                        cityFieldId: 'long_text5'
                    },
                    {
                        name: 'SKD',
                        boardId: '1410697073',
                        goodGroupIds: ['nowa_grupa36356'],
                        cityFieldId: 'tekst7'
                    }
                ]
            },
            {
                name: 'Spain',
                industries: [

                ]
            },
            {
                name: 'Germany',
                industries: [

                ]
            },
            {
                name: 'UK',
                industries: [

                ]
            }
        ];

        // Create a new map.
        const map = new mapboxgl.Map({
            container: 'map',
            // Choose from Mapbox's core styles, or make your own style with Mapbox Studio
            style: 'mapbox://styles/mapbox/streets-v12',
            center: [
                21.00489285129794,
                52.212130350909234
            ],
            zoom: 5
        });

        map.on('load', () => {

            toggleSidebar('left');

            map.addSource('regions', {
                'type': 'geojson',
                'data': 'data/poland.json'
            });

            map.addLayer({
                'id': 'regions-layer',
                'type': 'fill',
                'source': 'regions',
                'paint': {
                    'fill-color': 'rgba(200, 100, 240, 0.2)',
                    'fill-outline-color': 'rgba(200, 100, 240, 1)'
                }
            });

            map.addSource('labels', {
                'type': 'geojson',
                'data': 'data/poland-labels.json'
            });

            map.addLayer({
                'id': 'labels-icon-layer',
                'type': 'circle',
                'source': 'labels',
                'paint': {
                    'circle-radius': 6,
                    'circle-color': '#B42222'
                }
            });

            map.addLayer({
                'id': 'labels-layer',
                'type': 'symbol',
                'source': 'labels',
                'layout': {
                    'text-field': ['get', 'name'],
                    'text-size': 14,
                    'text-anchor': 'center',
                    'text-offset': [0,1]
                }
            });

            map.on('mouseenter', 'regions-layer', () => {
                map.getCanvas().style.cursor = 'pointer';
            });

            map.on('mouseleave', 'regions-layer', () => {
                map.getCanvas().style.cursor = '';
            });

            if (mondayToken == null) {
                showModalToSetToken();
            }
        });

        const monday = window.mondaySdk();



        function toggleSidebar(id) {
            const elem = document.getElementById(id);
            const collapsed = elem.classList.toggle('collapsed');
            const padding = {};
            padding[id] = collapsed ? 0 : 300;
            const sidebarArrow = document.getElementById('sidebar-arrow');
            sidebarArrow.innerHTML = collapsed ? '&rarr;' : '&larr;';
            map.easeTo({
                padding: padding,
                duration: 1000
            });
        }

        function showModalToSetToken() {
            console.log('Enter Token');
            bootbox.prompt('Please enter your token',
                function (result) {
                    localStorage.setItem('monday-token', result);
                });
        }

        function listCountries() {
            $('#countries').empty();
            let countryNames = countries.map(c => {
                let countryItem = $(`<li>${c.name}</li>`);
                $('#countries').append(countryItem);
                countryItem.click(() => {
                    listIndustriesByCountry(c.name);
                });
            });

        }

        function listIndustriesByCountry(countryName) {
            $('#industries').empty();
            const insdustries = countries.find(c => c.name == countryName).industries.map(i => {
                let industryItem = $(`<li>${i.name}</li>`);
                $('#industries').append(industryItem);
                industryItem.click(() => {
                    listLeadsByIndustry(i);
                });
            });
        }

        function listLeadsByIndustry(industry) {
            let query = `query GetBoardItems{  
                    boards(ids: [${industry.boardId}]) {  
                        name
                        groups(ids: ["${industry.goodGroupIds.join('","')}"]){
                            title
                            items_page {  
                                items {  
                                    id  
                                    name 
                                    column_values(ids: ["email", "tekst7", "long_text5"]) {  
                                        id  
                                        value  
                                    }  
                                }  
                            }  
                        }
                    }  
                }`;

            console.log(query);

            monday.api(query, {
                apiVersion: '2023-10',
                token: mondayToken
            }).then(res => {
                console.log('result');
                console.log(res);
            });

        }

        listCountries();
    </script>

</body>

</html>