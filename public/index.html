<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Lead Map</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.css" rel="stylesheet">
    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
    </style>
    <link href="style.css" rel="stylesheet">


    <script src="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/monday-sdk-js/dist/main.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>


    <script src="https://www.gstatic.com/firebasejs/8.7.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.7.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.7.1/firebase-analytics.js"></script>

</head>

<body>

    <div id="map">
        <div id="left" class="sidebar flex-center left collapsed">
            <div class="sidebar-content rounded-rect flex-center">
                <div class="legend">
                    <b>Countries</b>
                    <div>
                        <ul id="countries">

                        </ul>
                    </div>
                    <b>Industries</b>
                    <div>
                        <ul id="industries">

                        </ul>
                    </div>
                    <b>Good Leads</b>
                    <div>
                        <ul id="leads">

                        </ul>
                    </div>
                    <b>Clients</b>
                    <div id="clients">
                    </div>
                </div>
                <div id="sidebar-arrow" class="sidebar-toggle rounded-rect left" onclick="toggleSidebar('left')">
                    &rarr;
                </div>
            </div>
        </div>
    </div>



    <script src="js/jquery.min.js"></script>
    <script src="bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="js/bootbox.js"></script>


    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoieWFycmFyYW5nZXMiLCJhIjoiY2tydHpnM2pwOXdldzJubDM1b2dvcm15cCJ9.sAkVnbCzwrVLLRi7xxiHnA';
        let mondayToken = localStorage.getItem('monday-token');
        let selectedCountry;
        let selectedIndustry;
        let selectedLeads;

        const countries = [
            {
                name: 'Poland',
                code: 'pl',
                regionBordersUrl: 'data/poland.json',
                regionLabelsUrl: 'data/poland-labels.json',
                industries: [
                    {
                        name: 'Photovoltaic',
                        boardId: '1284229859',
                        goodGroupIds: ['nowa_grupa24985', 'new_group17485'], // nowa_grupa10322: this is Send group used for testing
                        cityFieldId: 'long_text5'
                    },
                    {
                        name: 'SKD',
                        boardId: '1410697073',
                        goodGroupIds: ['nowa_grupa36356'],
                        cityFieldId: 'tekst7'
                    }
                ]
            },
            {
                name: 'Spain',
                code: 'es',
                regionBordersUrl: 'data/spain.json',
                regionLabelsUrl: 'data/spain-labels.json',
                industries: [

                ]
            },
            {
                name: 'Germany',
                code: 'de',
                regionBordersUrl: 'data/germany.json',
                regionLabelsUrl: 'data/germany-labels.json',
                industries: [

                ]
            },
            {
                name: 'UK',
                code: 'uk',
                regionBordersUrl: 'data/uk.json',
                regionLabelsUrl: 'data/uk-labels.json',
                industries: [

                ]
            }
        ];

        // Create a new map.
        const map = new mapboxgl.Map({
            container: 'map',
            // Choose from Mapbox's core styles, or make your own style with Mapbox Studio
            style: 'mapbox://styles/mapbox/streets-v12',
            center: [
                21.00489285129794,
                52.212130350909234
            ],
            zoom: 4
        });

        map.on('load', () => {

            toggleSidebar('left');

            map.addSource('regions', {
                'type': 'geojson',
                'data': null
            });

            map.addLayer({
                'id': 'regions-layer',
                'type': 'fill',
                'source': 'regions',
                'paint': {
                    'fill-color': 'rgba(200, 100, 240, 0.2)',
                    'fill-outline-color': 'rgba(200, 100, 240, 1)'
                }
            });

            map.addSource('labels', {
                'type': 'geojson',
                'data': null
            });

            map.addLayer({
                'id': 'labels-icon-layer',
                'source': 'labels',
                'type': 'circle',
                'paint': {
                    'circle-radius': 6,
                    'circle-color': '#B42222'
                }
            });

            map.addLayer({
                'id': 'labels-layer',
                'type': 'symbol',
                'source': 'labels',
                'layout': {
                    'text-field': ['get', 'name'],
                    'text-size': 14,
                    'text-anchor': 'center',
                    'text-offset': [0, 1]
                }
            });

            map.addSource('leads', {
                'type': 'geojson',
                'data': null,
                cluster: true,
                clusterMaxZoom: 14, // Max zoom to cluster points on
                clusterRadius: 50 // Radius of each cluster when clustering points (defaults to 50)
            });

            map.addLayer({
                id: 'lead-clusters',
                type: 'circle',
                source: 'leads',
                filter: ['has', 'point_count'],
                paint: {
                    'circle-color': [
                        'step',
                        ['get', 'point_count'],
                        '#51bbd6',
                        100,
                        '#f1f075',
                        750,
                        '#f28cb1'
                    ],
                    'circle-radius': [
                        'step',
                        ['get', 'point_count'],
                        20,
                        100,
                        30,
                        750,
                        40
                    ]
                }
            });

            map.addLayer({
                id: 'lead-cluster-count',
                type: 'symbol',
                source: 'leads',
                filter: ['has', 'point_count'],
                layout: {
                    'text-field': ['get', 'point_count_abbreviated'],
                    'text-font': ['DIN Offc Pro Medium', 'Arial Unicode MS Bold'],
                    'text-size': 12
                }
            });

            // inspect a cluster on click
            map.on('click', 'lead-clusters', (e) => {
                const features = map.queryRenderedFeatures(e.point, {
                    layers: ['lead-clusters']
                });
                const clusterId = features[0].properties.cluster_id;
                map.getSource('leads').getClusterExpansionZoom(
                    clusterId,
                    (err, zoom) => {
                        if (err) return;

                        map.easeTo({
                            center: features[0].geometry.coordinates,
                            zoom: zoom
                        });
                    }
                );
            });




            map.loadImage('markers/cb0d0c.png', (error, image) => {
                if (error) throw error;
                map.addImage('lead-marker', image);

                map.addLayer({
                    'id': 'leads-layer',
                    'source': 'leads',
                    "type": "symbol",
                    "filter": ['!', ['has', 'point_count']],
                    "layout": {
                        "icon-image": "lead-marker",
                        "icon-allow-overlap": true,
                        'text-field': ['get', 'name'],
                        'text-offset': [0, 1.25],
                        'text-anchor': 'top'
                    }
                });

            });


            map.on('mouseenter', 'regions-layer', () => {
                map.getCanvas().style.cursor = 'pointer';
            });

            map.on('mouseleave', 'regions-layer', () => {
                map.getCanvas().style.cursor = '';
            });

            if (mondayToken == null) {
                showModalToSetToken();
            }
        });

        const monday = window.mondaySdk();



        function toggleSidebar(id) {
            const elem = document.getElementById(id);
            const collapsed = elem.classList.toggle('collapsed');
            const padding = {};
            padding[id] = collapsed ? 0 : 300;
            const sidebarArrow = document.getElementById('sidebar-arrow');
            sidebarArrow.innerHTML = collapsed ? '&rarr;' : '&larr;';
            map.easeTo({
                padding: padding,
                duration: 1000
            });
        }

        function showModalToSetToken() {
            bootbox.prompt('Please enter your token',
                function (result) {
                    mondayToken = result;
                    localStorage.setItem('monday-token', mondayToken);
                });
        }

        function listCountries() {
            $('#countries').empty();
            let countryNames = countries.map(c => {
                let countryItem = $(`<li>${c.name}</li>`);
                $('#countries').append(countryItem);
                countryItem.click(() => {

                    map.getSource('regions').setData(c.regionBordersUrl);
                    map.getSource('labels').setData(c.regionLabelsUrl);
                    map.getSource('leads').setData({ "type": "FeatureCollection", "features": [] });

                    fetch(c.regionBordersUrl)
                        .then((response) => response.json())
                        .then(function (geojson) {
                            const bbox = turf.bbox(geojson);
                            map.fitBounds(bbox, {
                                padding: { top: 50, bottom: 50, left: 100, right: 50 }
                            });
                        });

                    listIndustriesByCountry(c.name);
                });
            });

        }

        function listIndustriesByCountry(countryName) {
            $('#industries').empty();
            $('#leads').empty();
            const insdustries = countries.find(c => c.name == countryName).industries.map(i => {
                let industryItem = $(`<li>${i.name}</li>`);
                $('#industries').append(industryItem);
                industryItem.click(() => {
                    listLeadsByIndustry(i, countryName);
                });
            });
        }

        function listLeadsByIndustry(industry, country) {
            let query = `query GetBoardItems{  
                    boards(ids: [${industry.boardId}]) {  
                        name
                        groups(ids: ["${industry.goodGroupIds.join('","')}"]){
                            title
                            items_page(limit: 500) {  
                                items {  
                                    id  
                                    name 
                                    column_values(ids: ["email", "lead_email" "tekst7", "long_text5"]) {  
                                        id  
                                        value  
                                    }  
                                }  
                            }  
                        }
                    }  
                }`;

            monday.api(query, {
                apiVersion: '2023-10',
                token: mondayToken
            }).then(res => {
                selectedLeads = [];
                let leadAddresses = [];
                res.data.boards[0].groups.map(g => {

                    g.items_page.items.map(li => {
                        let leadEmail = JSON.parse(li.column_values.filter(cv => cv.id == 'email' || cv.id == 'lead_email')[0].value)?.email;
                        let leadCity = '';
                        const cityColumn = li.column_values.filter(cv => cv.id != 'email' && cv.id != 'lead_email')[0].value;
                        if (cityColumn.startsWith('{')) {
                            leadCity = JSON.parse(cityColumn).text;
                        }
                        else {
                            leadCity = cityColumn
                        }

                        leadCity = leadCity.replaceAll('\"', '');


                        selectedLeads.push({
                            id: li.id,
                            name: li.name,
                            email: leadEmail,
                            city: leadCity,
                            address: leadCity + ' ' + country
                        });
                    });

                });

                displayLeads(selectedLeads);
                createAddressIfNotExist(selectedLeads.map(l => l.address));

            });

        }

        function displayLeads(leads) {

            let cities = leads.map(le => le.city);

            $('#leads').empty();
            leads.map(le => {
                let leadItem = $(`<li>${le.name} <span class="city">${le.city}</span></li>`);
                $('#leads').append(leadItem);

                leadItem.click(() => {
                    console.log(le.id);
                });
            });
        }

        listCountries();

        const firebaseConfig = {
            apiKey: "AIzaSyDsnXEGVGThb-OnBXG20PjFvRMdgFw-vDc",
            authDomain: "lemon-lead-map.firebaseapp.com",
            projectId: "lemon-lead-map",
            storageBucket: "lemon-lead-map.appspot.com",
            messagingSenderId: "1095389983309",
            appId: "1:1095389983309:web:5eb6344c31006cdb8e6204"
        };
        firebase.initializeApp(firebaseConfig);
        firebase.analytics();
        const db = firebase.firestore();

        /* db.collection('address_book').get().then((snapshot) => {
            snapshot.docs.forEach(doc => {
                console.log(doc.data());
            });
        });

        db.collection('address_book').where('address', '==', 'Kraków 31-950').get().then((snapshot) => {
            console.log('found', snapshot.docs.length);
            snapshot.docs.forEach(doc => {
                console.log(doc.data());
            });
        });

        db.collection('address_book').where('address', '==', 'Poland Kraków 31-950').get().then((snapshot) => {
            console.log('not found', snapshot.docs.length);
            snapshot.docs.forEach(doc => {
                console.log(doc.data());
            });
        }); */

        /*  db.collection("cafes").add({
             name: form.name.value,
             city: form.city.value,
         }); */

        function createAddressIfNotExist(addresses) {
            let addressCreatePromises = [];
            let addressCheckPromises = [];

            addresses.forEach(address => {
                addressCheckPromises.push(
                    db.collection('address_book').where('address', '==', address).get().then((snapshot) => {
                        if (snapshot.docs.length == 0) {
                            return address
                        }
                    })
                );
            });

            Promise.all(addressCheckPromises).then((values) => {
                values.forEach(address => {
                    if (address) {
                        addressCreatePromises.push(
                            db.collection("address_book").add({
                                address: address
                            }).then(() => {
                                return address;
                            })
                        );
                    }
                });
                Promise.all(addressCreatePromises).then((values) => {
                    //display them on map
                    displayLeadsOnMap();
                });
            });



        }

        function displayLeadsOnMap() {

            let geojson = {
                "name": "NewFeatureType",
                "type": "FeatureCollection",
                "features": []
            };

            let uniqueAdresses = selectedLeads.map(l => l.address);
            uniqueAdresses = uniqueAdresses.filter(onlyUnique);

            const batches = [];

            while (uniqueAdresses.length) {
                // firestore limits batches to 10
                const batch = uniqueAdresses.splice(0, 10);

                // add the batch request to to a queue
                batches.push(
                    db.collection('address_book')
                        .where(
                            'address',
                            'in',
                            [...batch]
                        )
                        .get()
                        .then(results => results.docs.map(result => ({ /* id: result.id, */ ...result.data() })))
                )
            }

            // after all of the data is fetched, return it
            return Promise.all(batches)
                .then(content => {
                    content.flat().forEach(addressData => {
                        selectedLeads.filter(le => le.address == addressData.address).forEach(le => {
                            le['latitude'] = addressData.latitude;
                            le['longitude'] = addressData.longitude;
                        });
                    });

                    selectedLeads.map(le => {
                        geojson.features.push(
                            {
                                type: "Feature",
                                geometry: {
                                    type: "Point",
                                    coordinates: [le.longitude, le.latitude]
                                },
                                properties: { ...le }
                            }
                        );
                    });
                    map.getSource('leads').setData(geojson);
                });
        }

        function onlyUnique(value, index, array) {
            return array.indexOf(value) === index;
        }


    </script>


</body>

</html>